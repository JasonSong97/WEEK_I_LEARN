# ğŸ“Foreign Key

ì™¸ë˜í‚¤ëŠ” ë°ì´í„°ë¥¼ ë°”ì¸ë”©í•˜ëŠ” ê²ƒì´ë‹¤.

ì‹¤ì œ ì—…ë¬´ì—ì„œëŠ” `constraints`ë¥¼ í™œìš©í•œë‹¤. `constraints`ë¥¼ ì„¤ì •í•˜ë¯€ë¡œì„œ SQLì— ìë™ì²´í¬ì™€ ë°ì´í„°ë¥¼ ë³´í˜¸í•œë‹¤.

ì—¬ê¸°ì„œ ë°ì´í„° ë³´ì•ˆ(data security)ì´ë€ ë§Œì•½ 1ëª…ì˜ ê³ ê°ì´ ì—¬ëŸ¬ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆëŠ” ê²½ìš°ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ì.

ì‹¤ìˆ˜ë¡œ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³ , ë‚˜ì¤‘ì— í•´ë‹¹ ë°ì´í„°ë¥¼ ì°¾ëŠ” ê²½ìš°ì—ëŠ” ì ˆëŒ€ë¡œ ì°¾ì„ ìˆ˜ ì—†ë‹¤. í•˜ì§€ë§Œ `foreign key`ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ë¬¸ì œë¥¼ íš¨ê³¼ì ì´ë©´ì„œ ìë™ìœ¼ë¡œ í”¼í•  ìˆ˜ ìˆë‹¤.

sample data

```sql
CREATE SCHEMA `new_schema` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE TABLE `new_schema`.`users` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'This is the primary index',
  `name` VARCHAR(45) NOT NULL DEFAULT 'N/A',
  `age` INT NULL,
  PRIMARY KEY (`id`)
);

INSERT INTO `new_schema`.`users` (`id`, `name`, `age`) VALUES 
  (1, 'John', 40),
  (2, 'May', 30),
  (3, 'Tim', 22);
  
  
CREATE TABLE `new_schema`.`orders` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `user_id` INT,
  `note` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`)
);
 
INSERT INTO `new_schema`.`orders` (`id`, `user_id`, `note`) VALUES 
  (1, 1, 'some information'), 
  (2, 2, 'some comments'),
  (3, 2, 'no comments'),
  (4, 3, 'more comments');
```

![alt text](image/image-29.png)

## basic syntax & usage

```sql
ALTER TABLE `new_schema`.`orders`
    ADD CONSTRAINT `orders_user_id_key`
    FOREIGN KEY (`user_id`)
    REFERENCES `new_schema`.`users` (`id`);
```

- `ALTER TABLE`: ì–´ë–¤ í…Œì´ë¸”ì„ ì„¤ì •í• ì§€
- `ADD CONSTRAINT`: ì œì•½ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ì‹¶ì€ ì´ë¦„ì•ì— ë¶™ì´ëŠ” ê²ƒ, ìš°ë¦¬ëŠ” `orders_user_id_key`ì— ì œì•½ì¡°ê±´ì„ ì ìš©
- `FOREIGN KEY`: ìš°ë¦¬ê°€ ë°”ì¸ë”©í•˜ê³  ì‹¶ì€ í…Œì´ë¸”ì˜ foreign key
- `references`: ì–´ë–¤ ì™¸ë¶€ í…Œì´ë¸”ê³¼ ë¬¶ì´ê²Œ ë§Œë“¤ê²ƒì¸ì§€, ì—¬ê¸°ì„œëŠ” users í…Œì´ë¸”ì˜ idì— ì ìš©

### protection from delete

ìœ„ì—ì™€ ê°™ì€ ì¡°ê±´ì„ ë§Œë“¤ë©´, ì‚­ì œë¥¼ ë³´í˜¸í•  ìˆ˜ ìˆë‹¤.

```sql
DELETE FROM `new_schema`.`users` WHERE (`id` = `1`);
```

```text
ERROR 1451: 1451: Cannot delete or update a parent row: a foreign key constraint fails.
```

ë‹¤ìŒê³¼ ê°™ì´ ì—ëŸ¬ë©”ì„¸ì§€ê°€ ë‚˜ì˜¨ ì´ìœ ëŠ” `orders` í…Œì´ë¸”ì˜ `user_id`ì™€ ì—°ê²°ì´ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ë‚˜ì™”ë‹¤.

### protection from update

```sql
UPDATE `new_shema`.`users` SET `id` = `6` WHERE (`id` = `1`);
```

```text
ERROR 1451: 1451: Cannot delete or update a parent row: a foreign key constraint fails
```

ì´ê²ƒ ë˜í•œ ë™ì¼í•œ ì´ìœ ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. í•˜ì§€ë§Œ ì•„ë˜ì˜ ê²½ìš° ì‘ë™í•œë‹¤.

```sql
UPDATE `new_shema`.`users` SET `name` = `Tony` WHERE (`id` = `1`);
UPDATE `new_shema`.`users` SET `user_id` = `3` WHERE (`id` = `1`);
```

ì™œëƒí•˜ë©´ ì œì•½ì¡°ê±´ì„ ìœ„ë°˜í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìˆ˜í–‰ì´ ê°€ëŠ¥í•˜ë‹¤.

### remove a constraint

```sql
ALTER TABLE `new_schema`.`orders`
    DROP FOREIGN KEY `orders_user_id_key`;
```

## diverse constraints

ì œì•½ ì¡°ê±´ì„ ìƒì„±í•  ë•Œ `mode`ë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ë””í´íŠ¸ `no action`ìœ¼ë¡œ ëœë‹¤. `no action`ì˜ ê²½ìš° `mysql`ì˜ `restrict` ëª¨ë“œì™€ ë™ì¼í•˜ë‹¤. 

ì´ ê²½ìš°ì¼ ë•ŒëŠ” `update` ë˜ëŠ” `delete`ì˜ ê²½ìš° ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

## syntax

```sql
ALTER TABLE `new_schema`.`orders`
    ADD CONSTRAINT `orders_user_id_key`
    FOREIGN KEY(`user_id`)
    REFERENCES `new_schema`.`users` (`id`)
    ON DELETE NO ACTION
    ON UPDATE RESTRICT;
```

- `ON DELETE NO ACTION`: usersí–‰ì´ ì‚­ì œë˜ì–´ë„ ì°¸ì¡°í‚¤ë¥¼ ê°€ì§€ê³  ìˆëŠ” ordersì˜ í–‰ì€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ê²ƒ
- `ON UPDATE RESTRICTS`: ordersê°€ ì°¸ì¡°í•˜ê³  ìˆëŠ” usersì˜ í–‰ì´ ë³€ê²½ì´ ìˆì–´ë„ orders í…Œì´ë¸”ì˜ í–‰ì„ ì—…ë°ì´íŠ¸í•˜ì§€ ëª»í•¨.

## referential Actions

ì œì•½ì¡°ê±´ì—ì„œ `no action`ê³¼ `restrict`ëŠ” `referential actions`ë¼ê³  ë¶€ë¥¸ë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ sqlì—ì„œëŠ” ë‹¤ë¥¸ 2ê°€ì§€ ëª¨ë“œë¥¼ ì œê³µí•œë‹¤.

- `cascade`: ë§Œì•½ userì˜ idê°€ 6ìœ¼ë¡œ ë³€ê²½ì´ ë˜ì—ˆë‹¤ë©´, ìë™ìœ¼ë¡œ ordersí…Œì´ë¸”ì˜ user_idê°€ 6ìœ¼ë¡œ ë³€ê²½ì´ ë˜ëŠ” ê²ƒ.

- `set null`: ë§Œì•½ userì˜ idê°€ 6ìœ¼ë¡œ ë³€ê²½ì´ ë˜ì—ˆë‹¤ë©´, orders í…Œì´ë¸”ì˜ user_idëŠ” nullë¡œ ë³€ê²½ì´ ë˜ëŠ” ê²ƒ.

[mysql foreign key constraints manual](https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html)

# ğŸ“Transaction

# ğŸ“ACID

# ğŸ“Index

# ğŸ“User Privilege