# ğŸ“Foreign Key

ì™¸ë˜í‚¤ëŠ” ë°ì´í„°ë¥¼ ë°”ì¸ë”©í•˜ëŠ” ê²ƒì´ë‹¤.

ì‹¤ì œ ì—…ë¬´ì—ì„œëŠ” `constraints`ë¥¼ í™œìš©í•œë‹¤. `constraints`ë¥¼ ì„¤ì •í•˜ë¯€ë¡œì„œ SQLì— ìë™ì²´í¬ì™€ ë°ì´í„°ë¥¼ ë³´í˜¸í•œë‹¤.

ì—¬ê¸°ì„œ ë°ì´í„° ë³´ì•ˆ(data security)ì´ë€ ë§Œì•½ 1ëª…ì˜ ê³ ê°ì´ ì—¬ëŸ¬ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆëŠ” ê²½ìš°ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ì.

ì‹¤ìˆ˜ë¡œ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³ , ë‚˜ì¤‘ì— í•´ë‹¹ ë°ì´í„°ë¥¼ ì°¾ëŠ” ê²½ìš°ì—ëŠ” ì ˆëŒ€ë¡œ ì°¾ì„ ìˆ˜ ì—†ë‹¤. í•˜ì§€ë§Œ `foreign key`ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ë¬¸ì œë¥¼ íš¨ê³¼ì ì´ë©´ì„œ ìë™ìœ¼ë¡œ í”¼í•  ìˆ˜ ìˆë‹¤.

sample data

```sql
CREATE SCHEMA `new_schema` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE TABLE `new_schema`.`users` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'This is the primary index',
  `name` VARCHAR(45) NOT NULL DEFAULT 'N/A',
  `age` INT NULL,
  PRIMARY KEY (`id`)
);

INSERT INTO `new_schema`.`users` (`id`, `name`, `age`) VALUES 
  (1, 'John', 40),
  (2, 'May', 30),
  (3, 'Tim', 22);
  
  
CREATE TABLE `new_schema`.`orders` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `user_id` INT,
  `note` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`)
);
 
INSERT INTO `new_schema`.`orders` (`id`, `user_id`, `note`) VALUES 
  (1, 1, 'some information'), 
  (2, 2, 'some comments'),
  (3, 2, 'no comments'),
  (4, 3, 'more comments');
```

![alt text](image/image-29.png)

## basic syntax & usage

```sql
ALTER TABLE `new_schema`.`orders`
    ADD CONSTRAINT `orders_user_id_key`
    FOREIGN KEY (`user_id`)
    REFERENCES `new_schema`.`users` (`id`);
```

- `ALTER TABLE`: ì–´ë–¤ í…Œì´ë¸”ì„ ì„¤ì •í• ì§€
- `ADD CONSTRAINT`: ì œì•½ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ì‹¶ì€ ì´ë¦„ì•ì— ë¶™ì´ëŠ” ê²ƒ, ìš°ë¦¬ëŠ” `orders_user_id_key`ì— ì œì•½ì¡°ê±´ì„ ì ìš©
- `FOREIGN KEY`: ìš°ë¦¬ê°€ ë°”ì¸ë”©í•˜ê³  ì‹¶ì€ í…Œì´ë¸”ì˜ foreign key
- `references`: ì–´ë–¤ ì™¸ë¶€ í…Œì´ë¸”ê³¼ ë¬¶ì´ê²Œ ë§Œë“¤ê²ƒì¸ì§€, ì—¬ê¸°ì„œëŠ” users í…Œì´ë¸”ì˜ idì— ì ìš©

### protection from delete

ìœ„ì—ì™€ ê°™ì€ ì¡°ê±´ì„ ë§Œë“¤ë©´, ì‚­ì œë¥¼ ë³´í˜¸í•  ìˆ˜ ìˆë‹¤.

```sql
DELETE FROM `new_schema`.`users` WHERE (`id` = `1`);
```

```text
ERROR 1451: 1451: Cannot delete or update a parent row: a foreign key constraint fails.
```

ë‹¤ìŒê³¼ ê°™ì´ ì—ëŸ¬ë©”ì„¸ì§€ê°€ ë‚˜ì˜¨ ì´ìœ ëŠ” `orders` í…Œì´ë¸”ì˜ `user_id`ì™€ ì—°ê²°ì´ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ë‚˜ì™”ë‹¤.

### protection from update

```sql
UPDATE `new_shema`.`users` SET `id` = `6` WHERE (`id` = `1`);
```

```text
ERROR 1451: 1451: Cannot delete or update a parent row: a foreign key constraint fails
```

ì´ê²ƒ ë˜í•œ ë™ì¼í•œ ì´ìœ ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. í•˜ì§€ë§Œ ì•„ë˜ì˜ ê²½ìš° ì‘ë™í•œë‹¤.

```sql
UPDATE `new_shema`.`users` SET `name` = `Tony` WHERE (`id` = `1`);
UPDATE `new_shema`.`users` SET `user_id` = `3` WHERE (`id` = `1`);
```

ì™œëƒí•˜ë©´ ì œì•½ì¡°ê±´ì„ ìœ„ë°˜í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìˆ˜í–‰ì´ ê°€ëŠ¥í•˜ë‹¤.

### remove a constraint

```sql
ALTER TABLE `new_schema`.`orders`
    DROP FOREIGN KEY `orders_user_id_key`;
```

## diverse constraints

ì œì•½ ì¡°ê±´ì„ ìƒì„±í•  ë•Œ `mode`ë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ë””í´íŠ¸ `no action`ìœ¼ë¡œ ëœë‹¤. `no action`ì˜ ê²½ìš° `mysql`ì˜ `restrict` ëª¨ë“œì™€ ë™ì¼í•˜ë‹¤. 

ì´ ê²½ìš°ì¼ ë•ŒëŠ” `update` ë˜ëŠ” `delete`ì˜ ê²½ìš° ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

## syntax

```sql
ALTER TABLE `new_schema`.`orders`
    ADD CONSTRAINT `orders_user_id_key`
    FOREIGN KEY(`user_id`)
    REFERENCES `new_schema`.`users` (`id`)
    ON DELETE NO ACTION
    ON UPDATE RESTRICT;
```

- `ON DELETE NO ACTION`: usersí–‰ì´ ì‚­ì œë˜ì–´ë„ ì°¸ì¡°í‚¤ë¥¼ ê°€ì§€ê³  ìˆëŠ” ordersì˜ í–‰ì€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ê²ƒ
- `ON UPDATE RESTRICTS`: ordersê°€ ì°¸ì¡°í•˜ê³  ìˆëŠ” usersì˜ í–‰ì´ ë³€ê²½ì´ ìˆì–´ë„ orders í…Œì´ë¸”ì˜ í–‰ì„ ì—…ë°ì´íŠ¸í•˜ì§€ ëª»í•¨.

## referential Actions

ì œì•½ì¡°ê±´ì—ì„œ `no action`ê³¼ `restrict`ëŠ” `referential actions`ë¼ê³  ë¶€ë¥¸ë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ sqlì—ì„œëŠ” ë‹¤ë¥¸ 2ê°€ì§€ ëª¨ë“œë¥¼ ì œê³µí•œë‹¤.

- `cascade`: ë§Œì•½ userì˜ idê°€ 6ìœ¼ë¡œ ë³€ê²½ì´ ë˜ì—ˆë‹¤ë©´, ìë™ìœ¼ë¡œ ordersí…Œì´ë¸”ì˜ user_idê°€ 6ìœ¼ë¡œ ë³€ê²½ì´ ë˜ëŠ” ê²ƒ.

- `set null`: ë§Œì•½ userì˜ idê°€ 6ìœ¼ë¡œ ë³€ê²½ì´ ë˜ì—ˆë‹¤ë©´, orders í…Œì´ë¸”ì˜ user_idëŠ” nullë¡œ ë³€ê²½ì´ ë˜ëŠ” ê²ƒ.

[mysql foreign key constraints manual](https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html)

# ğŸ“Transaction

íŠ¸ëœì ì…˜ì´ë€ SQLì—ì„œ ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ ì§€í‚¤ëŠ” ê²ƒ

`ëŒ€ë¶€ë¶„ì˜ Relational DatabaseëŠ” transactionì„ ì§€ì›í•˜ê³ , mongoDB ê°™ì€ ë¹„ê´€ê³„í˜• Databaseë„ ì§€ì›í•œë‹¤.`

[MongoDB transaction](https://www.mongodb.com/docs/manual/core/transactions/)

íŠ¸ëœì ì…˜ì€ 2ê°€ì§€ ì¢…ë¥˜ê°€ ì¡´ì¬ 1. `all success` 2. `all fail` ì˜ˆì‹œë¡œëŠ” ì€í–‰ ì´ì²´ê°€ ìˆìŒ.

sample data

```sql
CREATE SCHEMA `new_schema` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE TABLE `new_schema`.`products` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'This is the primary index',
  `title` VARCHAR(45) NOT NULL DEFAULT 'N/A',
  `price` INT NULL,
  PRIMARY KEY (`id`)
);

INSERT INTO `new_schema`.`products` (`id`, `price`, `title`) VALUES 
  (1, 10, 'chair'),
  (2, 100, 'desk'),
  (3, 200, 'bike'),
  (4, 200, 'motorcycle'),
  (5, 300, 'headphone'),
  (6, 300, 'phone');
```

![alt text](image/image-30.png)

## concept

íŠ¸ëœì ì…˜ì´ë¼ëŠ” `ë°•ìŠ¤`ì— ì—¬ëŸ¬ SQL statementë¥¼ ë„£ê³  ì‹¤í–‰í•˜ëŠ” ê²ƒ. 1ê°œì˜ chunkë¡œ ë˜ëŠ” ê²ƒ.

ê·¸ í›„ì— ë‚˜ì˜¨ ê²°ê³¼ëŠ” `store(ì €ì¥)` or `restore(ë³µêµ¬)`

## basic statement

```sql
--First Query
START TRANSACTION;

-- Second Queries
UPDATE `new_schema`.`products` SET `price` = '500' WHERE id = 5;
UPDATE `new_schema`.`products` SET `price` = '500' WHERE id = 6;

-- Third Query
COMMIT;
```

- `start transaction`: íŠ¸ëœì ì…˜ì˜ ì‹œì‘
- `commit`: ì €ì¥

MySQLì˜ workbenchì˜ ê²½ìš°, auto-commit mode(ê¸°ë³¸ê°’)ìœ¼ë¡œ ë˜ì–´ìˆìŒ.

ì´ ì˜ë¯¸ëŠ” MySQLì„ ì‘ì„±í•  ë•ŒëŠ” ì•ê³¼ ë’¤ì— ì‘ì„±í•œ, `start transaction`ê³¼ `commit`ì„ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìŒ.

[MySQL auto commit mode](https://dev.mysql.com/doc/refman/8.0/en/innodb-autocommit-commit-rollback.html)

## restore statement

ë§Œì•½ íŠ¸ëœì ì…˜ì„ ì‹œì‘í•˜ê³  ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë„ì¤‘ì— errorê°€ ë°œìƒí•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ

```sql
-- First Query
START TRANSACTION;

-- Second Queries
UPDATE `new_schema`.`products` SET `price` = '500' WHERE id = 5;
..
-- error happened here!
..
UPDATE `new_schema`.`products` SET `price` = '500' WHERE id = 6;

-- Third Query
ROLLBACK;
```

ì´ ê²½ìš°ëŠ” ë‹¤ë¦„ queryë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³ , `rollback`ìœ¼ë¡œ ì´ë™í•˜ê²Œ ë¨.

ì´ë ‡ê²Œ errorê°€ ë°œìƒí•¨ì— ë”°ë¼, rollbackì„ ì‹¤í–‰í•´ì„œ ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆìŒ.

íŠ¸ëœì ì…˜ì˜ ê²½ìš°, SQLë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ê¸°ìˆ ì–¸ì–´ì—ì„œë„ ì œê³µì´ ëœë‹¤.

- basic template

```sql
START TRANSACTION;

SELECT `new_schema`.`products` WHERE id = 5;
UPDATE `new_schema`.`products` SET `price` = '500' WHERE id = 5;

IF (@correct) THEN
  COMMIT;
ELSE
  ROLLBACK;
END IF;
```

- `sql control process`: [sql ì œì–´ í”„ë¡œì„¸ìŠ¤](https://dev.mysql.com/doc/refman/8.0/en/sql-compound-statements.html)
- `@correct`: [user defined variable](https://dev.mysql.com/doc/refman/8.0/en/user-variables.html)

# ğŸ“ACID

ACIDëŠ” ëŒ€ë¶€ë¶„ì˜ ë°ì´í„°ë² ì´ìŠ¤ ìƒì—ì„œ ì¤‘ìš”í•œ ë¶€ë¶„ì„ ì°¨ì§€í•¨.

ê° ë°ì´í„°ë² ì´ìŠ¤ì˜ ì„±ê²©ì— ë”°ë¼ì„œ ë‹¤ë¥´ê² ì§€ë§Œ, ACIDë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ê²ƒì€ ëª¨ë‘ ë™ì¼í•¨.

ë°ì´í„° ë² ì´ìŠ¤ì—ì„œ `distributed system deisgn problem(ë¶„ì‚° ì‹œìŠ¤í…œ ì„¤ê³„)` 

ACIDëŠ” ë§ì€ ë„ì›€ì„ ì¤€ë‹¤. ë”°ë¼ì„œ ACIDì—†ì´ `large traffic`ì„ í•´ê²°í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ëŠ” ë§¤ìš° í˜ë“¤ë‹¤. ì˜ˆë¥¼ ë“¤ë©´ `high concurrency problem`(ìˆœê°„ì ìœ¼ë¡œ ë™ì‹œì— ëª°ë¦¬ëŠ” ë¬¸ì œ)

## atomicity: the smallest unit

`ì—¬ëŸ¬ SQL statementê°€ ìˆëŠ” transactionì€ 1ê°œì˜ queryë¡œ ìƒê°í•˜ì.` ì™œëƒí•˜ë©´ transactionì˜ query statementë¥¼ ì‹¤í–‰í•˜ëŠ” ë„ì¤‘ `error`ê°€ ë°œìƒí•˜ë©´ í•´ë‹¹ transacionì€ `rollback`í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ë”°ë¼ì„œ `atomicity`ì— ê¸°ë°˜í•œ ì„¤ê³„ë¥¼ í†µí•´, SQLêµ¬ë¬¸ì´ 1 chunkë¡œ ì´ë£¨ì–´ì§€ë„ë¡ ë§Œë“¤ì–´ì¤˜ì•¼í•¨.

`automicity`ì— ê¸°ë°˜í•œ ì„¤ê³„ë¥¼ í•˜ì§€ì•Šìœ¼ë©´, ëŒ€ê·œëª¨ íŠ¸ëœì ì…˜ì—ì„œ `crash event`ê°€ ë°œìƒí•˜ê³  ì ˆë°˜ì€ executeë˜ê³  ì ˆë°˜ì€ executeë˜ì§€ ì•ŠëŠ” ì¼ì´ ë°œìƒí•©ë‹ˆë‹¤.

### example

Aê³„ì¢Œì™€ Bê³„ì¢Œê°€ ìˆìŒ. ë§Œì•½ ë°ì´í„°ë² ì´ìŠ¤ê°€ `automicity`ì— ê¸°ë°˜í•˜ì§€ ì•Šìœ¼ë©´, Aì—ì„œ ëˆì„ ì¸ì¶œ í›„, ì´ ë¶€ë¶„ê¹Œì§€ê°€ 1ê°œì˜ transactionìœ¼ë¡œ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ AëŠ” Bì—ê²Œ ì†¡ê¸ˆì„ í–ˆì§€ë§Œ `Bê°€ ë°›ëŠ” ë¡œì§ì˜ transaction`ì´ ë¬¶ì—¬ìˆì§€ ì•Šê¸° ë•Œë¬¸ì—, BëŠ” Aë¡œë¶€í„° ëˆì„ ë°›ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤.

## consistency: always make data consistent

`consistency`ëŠ” ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤. transactionë‚´ì—ì„œ sql statementê°€ ì „ë¶€ ì„±ê³µí•´ì„œ `commit`ì„ í•˜ê±°ë‚˜ ì—ëŸ¬ê°€ ë°œìƒí•´ì„œ `rollback`ì„ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì´ë¡œì¨ ë°ì´í„°ì˜ `ì¼ê´€ì„±`ë¥¼ ì§€í‚¬ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

## isolation: transactions do not affect each other

`isolation`ì€ ëŒ€ê·œëª¨ íŠ¸ë˜í”½ì´ ë°œìƒí•˜ê±°ë‚˜ íŠ¸ë˜í”½ì´ ì¦ê°€í•  ë•Œ ë°ì´í„°ì— ë°œìƒí•˜ëŠ” ë¬¸ì œë“¤ì„ í•´ê²°í• ë•Œ ì‚¬ìš©ì´ ë©ë‹ˆë‹¤.

ëŒ€ê·œëª¨ íŠ¸ë˜í”½ì´ ë°œìƒí•˜ê±°ë‚˜ ì¦ê°€í•˜ë©´, ë§ì€ recordì˜ ìˆ˜ì •ê³¼ ì‚­ì œê°€ ì´ë£¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì°¨ ë³µì¡ì„±ì´ ì˜¬ë¼ê°€ë©´ì„œ `ì–´ë–¤ versionì´ ì˜¬ë°”ë¥¸ì§€ ì„ íƒ`í•´ì•¼í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

ë”°ë¼ì„œ `isolation`ì— ê¸°ë°˜í•œ ë°ì´í„°ë² ì´ìŠ¤ëŠ” ëª¨ë“  transactionì€ ì„œë¡œì—ê²Œ ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ” ê²ƒì…ë‹ˆë‹¤.

[isolation level](https://en.wikipedia.org/wiki/Isolation_(database_systems)#Isolation_levels)

### example

public account Aê°€ ìˆìŠµë‹ˆë‹¤. Aì— `ì†¡ì¬ê·¼`ê³¼ `ëª…ì¬ìš°`ê°€ `ë™ì‹œì—` ì¸ì¶œ ë˜ëŠ” ì…ê¸ˆì„ í•˜ê²Œë˜ëŠ” ê²½ìš° ë¨¼ì € ì ‘ê·¼í•œ ì‚¬ëŒ(ì†¡ì¬ê·¼)ì—ê²Œ í•´ë‹¹ `record`ë¥¼ ë³€ê²½í•  ê¶Œë¦¬ë¥¼ ì£¼ê³  ì™¸ë¶€ì—ì„œ ì ‘ê·¼ì„ ëª»í•˜ê²Œ `lock`ì„ í•˜ê²Œ ë©ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ `ëª…ì¬ìš°`ëŠ” `queue`ì—ì„œ ê¸°ë‹¤ë¦¬ë©´ì„œ `ì†¡ì¬ê·¼`ì´ `unlock`ë ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.

```
Locked means the database prohibits any other transaction from modifying the locked record.
```

í•˜ì§€ë§Œ ì¢‹ì§€ì•Šì€ lock ë©”ì»¤ë‹ˆì¦˜ì€ `deadlock`ì„ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. -> [deadlock](https://docs.oracle.com/javadb/10.6.2.1/devguide/cdevconcepts28436.html)

## durability: always exist

`durability`ëŠ” `transaction`ìœ¼ë¡œ ë¶€í„° `commit`ì´ ë˜ë©´, ì»¤ë°‹ê²°ê³¼ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥ì´ ë˜ë„ë¡ SSDì™€ ê°™ì€ hard diskì— ì €ì¥í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### example

ë§Œì•½ `durability`ê°€ ì—†ë‹¤ë©´, `commit` ì´í›„ì— í•˜ë“œë””ìŠ¤í¬ì— ì—ëŸ¬ê°€ ìƒê²¨ ì „ì›ì´ ë‚˜ê°„ ê²½ìš°, commití•œ ë°ì´í„°ëŠ” í•˜ë“œë””ìŠ¤í¬ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

# ğŸ“Index

# ğŸ“User Privilege